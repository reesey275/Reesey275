name: Environment Policy Check

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  check-env-files:
    name: Verify No Forbidden Env Files Tracked
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for comprehensive check
      
      - name: Check for forbidden env files
        run: |
          echo "ğŸ” Checking for forbidden .env files in git index..."
          
          # Get all tracked env files
          TRACKED_ENV_FILES=$(git ls-files -- '.env*' 2>/dev/null || true)
          
          if [ -z "$TRACKED_ENV_FILES" ]; then
            echo "âœ… No .env files tracked (OK if project doesn't use env files)"
            exit 0
          fi
          
          # Allowlist
          ALLOWED_PATTERN='^\(.env\.example\|.env\.TEMPLATE\|.env\.template\)$'
          
          FAIL=0
          FORBIDDEN_FILES=""
          
          while IFS= read -r file; do
            filename=$(basename "$file")
            
            # Check if it's in allowlist
            if ! echo "$filename" | grep -q "$ALLOWED_PATTERN"; then
              echo "âŒ FORBIDDEN: $file"
              FORBIDDEN_FILES="${FORBIDDEN_FILES}${file}\n"
              FAIL=1
            else
              echo "âœ… ALLOWED: $file"
            fi
          done <<< "$TRACKED_ENV_FILES"
          
          if [ "$FAIL" -eq 1 ]; then
            echo ""
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ CI BLOCKED: Forbidden .env files are tracked"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo -e "Forbidden files:\n${FORBIDDEN_FILES}"
            echo ""
            echo "Only these env files are allowed to be committed:"
            echo "  â€¢ .env.example"
            echo "  â€¢ .env.TEMPLATE"
            echo "  â€¢ .env.template"
            echo ""
            echo "To fix:"
            echo "  git rm --cached <file>"
            echo "  # Then ensure .env is in .gitignore"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          echo ""
          echo "âœ… All tracked .env files are allowed"
      
      - name: Verify .gitignore contains env rules
        run: |
          echo "ğŸ” Checking .gitignore for env rules..."
          
          if [ ! -f .gitignore ]; then
            echo "âš ï¸  No .gitignore file found"
            exit 0
          fi
          
          # Check for .env ignore pattern
          if grep -q "^\.env$" .gitignore || grep -q "^\.env$" .gitignore; then
            echo "âœ… .env is ignored"
          else
            echo "âš ï¸  .env may not be properly ignored"
            echo "   Add this to .gitignore:"
            echo "   .env"
            echo "   .env.*"
            echo "   !.env.TEMPLATE"
            echo "   !.env.example"
          fi
